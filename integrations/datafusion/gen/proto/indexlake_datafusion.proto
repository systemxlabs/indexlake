syntax = "proto3";

package indexlake_datafusion;

import "datafusion_common.proto";
import "datafusion.proto";

message IndexLakePhysicalPlanNode {
  oneof IndexLakePhysicalPlanType {
    IndexLakeScanExecNode scan = 1;
    IndexLakeInsertExecNode insert = 2;
  }
}

message IndexLakeScanExecNode {
  string namespace_name = 1;
  string table_name = 2;
  uint32 partition_count = 3;
  repeated TableScanPartition partitions = 4;
  Projection projection = 5;
  repeated datafusion.LogicalExprNode filters = 6;
  uint32 batch_size = 7;
  optional uint32 limit = 8;
  datafusion_common.Schema schema = 9;
  repeated uint64 partition_row_counts = 10;
}

message TableScanPartition {
  oneof partition_type {
    TableScanPartitionAuto auto = 1;
    TableScanPartitionProvided provided = 2;
  }
}

message TableScanPartitionAuto {
  uint32 partition_idx = 1;
  uint32 partition_count = 2;
}

message TableScanPartitionProvided {
  bool contains_inline_rows = 1;
  repeated DataFile data_file_records = 2;
}

message IndexLakeInsertExecNode {
  string namespace_name = 1;
  string table_name = 2;
  datafusion.InsertOp insert_op = 3;
  uint32 bypass_insert_threshold = 4;
}

message Projection {
  repeated uint32 projection = 1;
}

message DataFile {
  bytes data_file_id = 1;
  bytes table_id = 2;
  DataFileFormat format = 3;
  string relative_path = 4;
  int64 size = 5;
  int64 record_count = 6;
  bytes validity = 7;
  int64 valid_record_count = 8;
}

enum DataFileFormat {
  ParquetV1 = 0;
  ParquetV2 = 1;
}
